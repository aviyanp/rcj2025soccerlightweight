#include <Arduino.h>

// Pin definitions
// Define IR sensor pins (analog input)
#define NUM_SENSORS 12
const int IR_PINS[NUM_SENSORS] = {A11, A10, A12, A13, A14, A15, A0, A1, A2, A3, A4, A5};

// Define motor control pins for DRV8874 motor driver (PWM and DIR for each motor)
const int MOTOR1_PWM = 2; // Motor 1
const int MOTOR1_DIR = 7;
const int MOTOR2_PWM = 3; // Motor 2
const int MOTOR2_DIR = 8;
const int MOTOR3_PWM = 4; // Motor 3
const int MOTOR3_DIR = 9;
const int MOTOR4_PWM = 6; // Motor 4 (MC5)
const int MOTOR4_DIR = 11;

// Variables for IR signal processing
int sensorValues[NUM_SENSORS];
int strongestSignalIndex = -1;
int strongestSignalValue = 0;

// Thresholds
const int STOP_THRESHOLD = 800;  // Threshold to stop before the ball (adjust as needed)
const int CLOSE_THRESHOLD = 700;  // Threshold to determine "very close" to the ball

// Function prototypes
void moveTowardsBall();
void pushBallOffCenter();
void reposition();
void moveToGoal();

// Setup function
void setup() {
    Serial.begin(115200);

    // Initialize IR sensor pins
    for (int i = 0; i < NUM_SENSORS; i++) {
        pinMode(IR_PINS[i], INPUT);
    }

    // Initialize motor control pins
    pinMode(MOTOR1_PWM, OUTPUT);
    pinMode(MOTOR1_DIR, OUTPUT);
    pinMode(MOTOR2_PWM, OUTPUT);
    pinMode(MOTOR2_DIR, OUTPUT);
    pinMode(MOTOR3_PWM, OUTPUT);
    pinMode(MOTOR3_DIR, OUTPUT);
    pinMode(MOTOR4_PWM, OUTPUT);
    pinMode(MOTOR4_DIR, OUTPUT);

    Serial.println("Robot initialized and ready to follow the ball.");
}

// Main loop
void loop() {
    // Find the strongest IR signal
    strongestSignalValue = 0; // Reset the strongest signal value
    strongestSignalIndex = -1; // Reset the strongest signal index

    for (int i = 0; i < NUM_SENSORS; i++) {
        sensorValues[i] = analogRead(IR_PINS[i]);
        if (sensorValues[i] > strongestSignalValue) {
            strongestSignalValue = sensorValues[i];
            strongestSignalIndex = i;
        }
    }

    // Move towards the ball
    moveTowardsBall();

    // Stop when close to the ball
    if (strongestSignalValue >= CLOSE_THRESHOLD) {
        delay(500);  // Pause briefly
        pushBallOffCenter();  // Push the ball slightly off-center
        reposition();  // Reposition the robot
        moveToGoal();  // Move towards the goal with the ball
    }
}

// Function to move towards the ball
void moveTowardsBall() {
    if (strongestSignalValue >= STOP_THRESHOLD) {
        // Stop the motors
        analogWrite(MOTOR1_PWM, 0);
        analogWrite(MOTOR2_PWM, 0);
        analogWrite(MOTOR3_PWM, 0);
        analogWrite(MOTOR4_PWM, 0);
    } else {
        // Move towards the ball (strafe in the strongest signal direction)
        int speed = 200;  // Adjust speed as needed
        if (strongestSignalIndex < NUM_SENSORS / 2) {
            // Move left
            analogWrite(MOTOR1_PWM, speed);
            analogWrite(MOTOR2_PWM, speed);
            digitalWrite(MOTOR1_DIR, LOW);  // Reverse
            digitalWrite(MOTOR2_DIR, HIGH); // Forward
            analogWrite(MOTOR3_PWM, speed);
            analogWrite(MOTOR4_PWM, speed);
            digitalWrite(MOTOR3_DIR, HIGH); // Forward
            digitalWrite(MOTOR4_DIR, LOW);  // Reverse
        } else {
            // Move right
            analogWrite(MOTOR1_PWM, speed);
            analogWrite(MOTOR2_PWM, speed);
            digitalWrite(MOTOR1_DIR, HIGH); // Forward
            digitalWrite(MOTOR2_DIR, LOW);  // Reverse
            analogWrite(MOTOR3_PWM, speed);
            analogWrite(MOTOR4_PWM, speed);
            digitalWrite(MOTOR3_DIR, LOW);  // Reverse
            digitalWrite(MOTOR4_DIR, HIGH); // Forward
        }
    }
}

// Function to push the ball slightly off-center
void pushBallOffCenter() {
    int speed = 150;  // Adjust speed as needed
    analogWrite(MOTOR1_PWM, speed);
    analogWrite(MOTOR2_PWM, speed);
    analogWrite(MOTOR3_PWM, speed);
    analogWrite(MOTOR4_PWM, speed);

    digitalWrite(MOTOR1_DIR, HIGH); // Forward
    digitalWrite(MOTOR2_DIR, HIGH); // Forward
    digitalWrite(MOTOR3_DIR, HIGH); // Forward
    digitalWrite(MOTOR4_DIR, HIGH); // Forward

    delay(1000);  // Push for 1 second (adjust as needed)
    analogWrite(MOTOR1_PWM, 0);
    analogWrite(MOTOR2_PWM, 0);
    analogWrite(MOTOR3_PWM, 0);
    analogWrite(MOTOR4_PWM, 0);
}

// Function to reposition the robot
void reposition() {
    int speed = 150;  // Adjust speed as needed
    analogWrite(MOTOR1_PWM, speed);
    analogWrite(MOTOR2_PWM, speed);
    analogWrite(MOTOR3_PWM, speed);
    analogWrite(MOTOR4_PWM, speed);

    digitalWrite(MOTOR1_DIR, LOW);  // Reverse
    digitalWrite(MOTOR2_DIR, LOW);  // Reverse
    digitalWrite(MOTOR3_DIR, LOW);  // Reverse
    digitalWrite(MOTOR4_DIR, LOW);  // Reverse

    delay(1000);  // Move back for 1 second (adjust as needed)
    analogWrite(MOTOR1_PWM, 0);
    analogWrite(MOTOR2_PWM, 0);
    analogWrite(MOTOR3_PWM, 0);
    analogWrite(MOTOR4_PWM, 0);
}

// Function to move towards the goal
void moveToGoal() {
    analogWrite(MOTOR1_PWM, 200);
    analogWrite(MOTOR2_PWM, 200);
    analogWrite(MOTOR3_PWM, 200);
    analogWrite(MOTOR4_PWM, 200);
    digitalWrite(MOTOR1_DIR, HIGH); // Forward
    digitalWrite(MOTOR2_DIR, HIGH); // Forward
    digitalWrite(MOTOR3_DIR, HIGH); // Forward
    digitalWrite(MOTOR4_DIR, HIGH); // Forward
    delay(3000);  // Move for 3 seconds (adjust as needed)
    analogWrite(MOTOR1_PWM, 0);
    analogWrite(MOTOR2_PWM, 0);
    analogWrite(MOTOR3_PWM, 0);
    analogWrite(MOTOR4_PWM, 0);
}
